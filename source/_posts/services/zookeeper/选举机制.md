---
title: zk选举
permalink: services/zookeeper/选举机制/
tags:
  - 服务发现
  - 选举
categories:
  - services
  - zookeeper
date: 2022-06-03 18:24:28
---

#### 核心机制

- 逻辑时间 epoch ,判断是否是同一轮投票(网络原因导致投票广播信息滞后)
- 事物ID(Zxid),事物ID最大的数据最新  
- 服务器ID(myid),数值大的权重大  

<!--more-->

```flow
start=>start: 选self
info=>operation: 广播信息
j1=>condition: 投票结果状态

j2=>condition:  是否过时
yj2=>operation: 清空投票信息
nj2=>operation: 更新投票信息

j3=>condition: 是否同一轮
yj3=>operation: 比较投票信息
nj3=>operation: 已完成投票信息

j=>condition:  是否形成共识
end=>end: 退出

start->info->j1
j1(yes)->j3
j1(no)->j2

j2(yes)->yj2(right)->nj2
j2(no)->nj2

j3(yes)->yj3->j
j3(no)->nj3->j

nj2->yj3->j
j(no)->info
j(yes)->end

```





####  比较逻辑

![](/pics/zk_flow_2232.png)



同一轮,对投票信息(epoch,zxid,myid)进行比较(zxid,myid)

是否过时:

*过时*(小于),更新使用self信息(epoch,zxid,myid)

非过时(大于),清空信息,更新(epoch)进行比较(zxid,myid)

  

根据以下规则,超过半数收到相同投票选出leader

> 逻辑时钟小的选举结果被忽略，重新投票
>
> 统一逻辑时钟后，事物ID大的胜出
>
> 事物ID相同的情况下，服务器ID大的胜出

